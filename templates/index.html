<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuroraShell Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header class="navbar">
    <div class="nav-links">
        <a href="/">Chat</a>
        <a href="/lmchat">LM Chat</a>
        <a href="/commands">Commands</a>
        <a href="/system">System Status</a>
        <span class="settings-link" onclick="toggleSettings()">Settings</span>
    </div>
    <div id="status-lights" class="status-lights"></div>
</header>
<div class="chat-container">
    <h1>AuroraShell</h1>
    {% include "_workflow.html" %}
    <div id="settings" class="settings-panel">
        <div class="svc">
            <label>LM Studio:<br>
                <select id="lmstudio_select" onchange="selectChanged('lmstudio')"></select>
                <button onclick="deleteServer('lmstudio')">Delete</button>
            </label>
        </div>
        <div class="svc">
            <label>AnythingLLM:<br>
                <select id="anythingllm_select" onchange="selectChanged('anythingllm')"></select>
                <button onclick="deleteServer('anythingllm')">Delete</button>
            </label>
        </div>
        <div class="svc">
            <label>N8N:<br>
                <select id="n8n_select" onchange="selectChanged('n8n')"></select>
                <button onclick="deleteServer('n8n')">Delete</button>
            </label>
        </div>
    </div>
    <div id="toast" class="toast" style="display:none"></div>
    <div id="chat-log" class="chat-log"></div>
    <div class="input-area">
        <select id="mode">
            <option value="chat">Chat</option>
            <option value="execute">Execute</option>
        </select>
        <input type="text" id="chat-input" placeholder="Type your message or command..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
<script>
const toastEl = document.getElementById('toast');
const settingsEl = document.getElementById('settings');
let settingsData = {};

async function loadSettings(){
    const res = await fetch('/settings');
    settingsData = await res.json();
    ['lmstudio','anythingllm','n8n'].forEach(svc=>{
        const sel = document.getElementById(svc + '_select');
        if(!sel) return;
        sel.innerHTML = '';
        const servers = settingsData[svc + '_servers'] || [];
        const currentUrl = settingsData[svc + '_url'] || '';
        servers.forEach((srv,i)=>{
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = srv.url;
            if(srv.url === currentUrl) opt.selected = true;
            sel.appendChild(opt);
        });
        const addOpt = document.createElement('option');
        addOpt.value = 'new';
        addOpt.textContent = 'Add new...';
        sel.appendChild(addOpt);
    });
}

function toggleSettings(){
    if(settingsEl.classList.contains('active')){
        settingsEl.classList.remove('active');
    } else {
        settingsEl.classList.add('active');
        loadSettings();
    }
}

function openSettings(service){
    if(!settingsEl.classList.contains('active')){
        toggleSettings();
    }
    const map = {lmstudio:'lmstudio_select', anythingllm:'anythingllm_select', n8n:'n8n_select'};
    const id = map[service];
    if(id){
        setTimeout(()=>{document.getElementById(id).focus();},100);
    }
}

async function saveSettings(){
    await fetch('/settings', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(settingsData)
    });
    showToast('Settings saved');
}

function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display='block';
    setTimeout(()=>{toastEl.style.display='none';},3000);
}

function selectChanged(service){
    const sel = document.getElementById(service + '_select');
    if(!sel) return;
    if(sel.value === 'new'){
        const url = prompt('Server URL:');
        if(!url){ loadSettings(); return; }
        const token = prompt('Token (optional):') || '';
        settingsData[service + '_servers'] = settingsData[service + '_servers'] || [];
        settingsData[service + '_servers'].push({url, token});
        settingsData[service + '_url'] = url;
        settingsData[service + '_token'] = token;
        saveSettings().then(loadSettings);
    } else {
        const idx = parseInt(sel.value,10);
        const srv = (settingsData[service + '_servers'] || [])[idx];
        if(srv){
            settingsData[service + '_url'] = srv.url;
            settingsData[service + '_token'] = srv.token;
            saveSettings();
        }
    }
}

function deleteServer(service){
    const sel = document.getElementById(service + '_select');
    const idx = parseInt(sel.value,10);
    if(isNaN(idx)) return;
    if(!confirm('Delete this server?')) return;
    const list = settingsData[service + '_servers'] || [];
    const removed = list.splice(idx,1);
    if(settingsData[service + '_url'] === removed[0].url){
        if(list.length){
            settingsData[service + '_url'] = list[0].url;
            settingsData[service + '_token'] = list[0].token;
        }else{
            settingsData[service + '_url'] = '';
            settingsData[service + '_token'] = '';
        }
    }
    settingsData[service + '_servers'] = list;
    saveSettings().then(loadSettings);
}

async function pollEvents(){
    const res = await fetch('/events');
    const events = await res.json();
    events.forEach(showToast);
}
setInterval(pollEvents,10000);

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const modeSel = document.getElementById('mode');
    const text = input.value;
    const mode = modeSel.value;
    if (!text) return;
    const log = document.getElementById('chat-log');
    log.innerHTML += `<div class='user-msg'>${text}</div>`;
    input.value = '';
    const res = await fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: text, mode: mode})
    });
    const data = await res.json();
    if (data.response) {
        log.innerHTML += `<div class='bot-msg'>${data.response}</div>`;
    } else if (data.plan) {
        log.innerHTML += `<div class='bot-msg'>Plan: ${JSON.stringify(data.plan)}</div>`;
        const approve = confirm('Execute this plan?');
        if (approve) {
            const res2 = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({approve: true})
            });
            const result = await res2.json();
            log.innerHTML += `<div class='bot-msg'>Result: ${JSON.stringify(result)}</div>`;
        }
    } else if (data.returncode !== undefined) {
        log.innerHTML += `<div class='bot-msg'>Result: ${JSON.stringify(data)}</div>`;
    } else if (data.error) {
        log.innerHTML += `<div class='bot-msg error'>Error: ${data.error}</div>`;
    }
    log.scrollTop = log.scrollHeight;
}

window.addEventListener('load', () => {
    const params = new URLSearchParams(window.location.search);
    const open = params.get('settings');
    if(open){
        openSettings(open);
    }
});
</script>
<script src="/static/status.js"></script>
</body>
</html>
